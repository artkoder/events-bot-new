# Автотемы для событий

Система автоматически классифицирует события по 23 зафиксированным темам. Метки
сохраняются в карточке события и выводятся администраторам в интерфейсе бота.

## Доступные темы

| Идентификатор | Подпись |
|---------------|---------|
| `STANDUP` | «Стендап и комедия» |
| `QUIZ_GAMES` | «Квизы и игры» |
| `OPEN_AIR` | «Фестивали и open-air» |
| `PARTIES` | «Вечеринки» |
| `CONCERTS` | «Концерты» |
| `MOVIES` | «Кино» |
| `EXHIBITIONS` | «Выставки и арт» |
| `THEATRE` | «Театр» |
| `THEATRE_CLASSIC` | «Классический театр и драма» |
| `THEATRE_MODERN` | «Современный и экспериментальный театр» |
| `LECTURES` | «Лекции и встречи» |
| `MASTERCLASS` | «Мастер-классы» |
| `PSYCHOLOGY` | «Психология» |
| `SCIENCE_POP` | «Научпоп» |
| `HANDMADE` | «Хендмейд/маркеты/ярмарки/МК» |
| `FASHION` | «Мода и стиль» |
| `NETWORKING` | «Нетворкинг и карьера» |
| `ACTIVE` | «Активный отдых и спорт» |
| `PERSONALITIES` | «Личности и встречи» |
| `HISTORICAL_IMMERSION` | «Исторические реконструкции и погружение» |
| `KIDS_SCHOOL` | «Дети и школа» |
| `FAMILY` | «Семейные события» |
| `KRAEVEDENIE_KALININGRAD_OBLAST` | «Краеведение Калининградской области» |

## Системный промпт

Классификатор использует модель 4o (или 4o-mini при включённой переменной
`FOUR_O_MINI`) с системным промптом из кода:

```
Ты — ассистент, который классифицирует культурные события по темам.
Верни JSON с массивом `topics`: выбери от 0 до 3 подходящих идентификаторов тем.
Используй только идентификаторы из списка ниже, записывай их ровно так, как показано, и не добавляй другие значения.
Не отмечай темы про скидки, «Бесплатно» или бесплатное участие и игнорируй «Фестивали», сетевые программы и серии мероприятий.
Не повторяй одинаковые идентификаторы.
Если в названии, описании или хэштегах явно указан возрастной ценз (например, «18+», «18 +», «(16+)», «16-18», «12–14 лет», «от 14 лет», «18 лет и старше», «21+ only»), то не выбирай темы `FAMILY` и `KIDS_SCHOOL`.
Возрастной ценз может записываться как число со знаком «+» (включая варианты с пробелами или скобками), как диапазон («12-16», «12–16 лет») или словами «от N лет», «N лет и старше», «для N+».
Допустимые темы:
- STANDUP — «Стендап и комедия»
- QUIZ_GAMES — «Квизы и игры»
- OPEN_AIR — «Фестивали и open-air»
- PARTIES — «Вечеринки»
- CONCERTS — «Концерты»
- MOVIES — «Кино»
- EXHIBITIONS — «Выставки и арт»
- THEATRE — «Театр»
- THEATRE_CLASSIC — «Классический театр и драма»
- THEATRE_MODERN — «Современный и экспериментальный театр»
- LECTURES — «Лекции и встречи»
- MASTERCLASS — «Мастер-классы»
- PSYCHOLOGY — «Психология»
- SCIENCE_POP — «Научпоп»
- HANDMADE — «Хендмейд/маркеты/ярмарки/МК»
- FASHION — «Мода и стиль»
- NETWORKING — «Нетворкинг и карьера»
- ACTIVE — «Активный отдых и спорт»
- PERSONALITIES — «Личности и встречи»
- HISTORICAL_IMMERSION — «Исторические реконструкции и погружение»
- KIDS_SCHOOL — «Дети и школа»
- FAMILY — «Семейные события»
- KRAEVEDENIE_KALININGRAD_OBLAST — «Краеведение Калининградской области»
Если ни одна тема не подходит, верни пустой массив.
Для театральных событий уточняй подтипы: `THEATRE_CLASSIC` ставь за постановки по канону — пьесы классических авторов (например, Шекспир, Мольер, Пушкин, Гоголь), исторические или мифологические сюжеты, традиционная драматургия; `THEATRE_MODERN` применяй к новой драме, современным текстам, экспериментальным, иммерсивным или мультимедийным форматам.
Если классический сюжет переосмыслен в современном или иммерсивном исполнении, ставь обе темы `THEATRE_CLASSIC` и `THEATRE_MODERN`.
```

> **Подсказка для операторов:** если в афише фигурируют авторы из школьного канона или классические сюжеты, оставляем `THEATRE_CLASSIC`. Добавляйте `THEATRE_MODERN`, когда текст подчёркивает новую драму, site-specific подход, иммерсивность или мультимедийные эксперименты — и обе метки, если классика подана в современном ключе. Для фестивалей и мероприятий с историческими лагерями, клубами реконструкции или костюмированными погружениями используйте `HISTORICAL_IMMERSION`.

## Формат ответа

От модели ожидается JSON, удовлетворяющий схеме:

```json
{
  "type": "object",
  "properties": {
    "topics": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "STANDUP", "QUIZ_GAMES", "OPEN_AIR", "PARTIES", "CONCERTS",
          "MOVIES", "EXHIBITIONS", "THEATRE", "THEATRE_CLASSIC",
          "THEATRE_MODERN", "LECTURES", "MASTERCLASS", "PSYCHOLOGY",
          "SCIENCE_POP", "HANDMADE", "FASHION", "NETWORKING", "ACTIVE",
          "PERSONALITIES", "HISTORICAL_IMMERSION", "KIDS_SCHOOL", "FAMILY",
          "KRAEVEDENIE_KALININGRAD_OBLAST"
        ]
      },
      "maxItems": 3,
      "uniqueItems": true
    }
  },
  "required": ["topics"],
  "additionalProperties": false
}
```

Выбираются до трёх уникальных идентификаторов. Пустой список означает, что
подходящих тем нет.

## Правила срабатывания

Классификатор вызывается, когда:

- бот сохраняет новые события через `/addevent` или VK-пайплайн; итоговые темы
  наследуются всеми копиями многодневных событий;
- администратор редактирует название, описание или «сырой» текст события
  (поле `source_text`) — переразметка выполняется только если событие не в
  ручном режиме;
- супер-администратор запускает `/backfill_topics` для пересчёта тем у будущих
  событий (по умолчанию в горизонте 90 дней).

В остальных случаях темы остаются без изменений.

### Региональные эвристики

Помимо ответа модели, `assign_event_topics` запускает постпроцессор. Он добавляет
тему `KRAEVEDENIE_KALININGRAD_OBLAST`, когда событие явно связано с
Калининградской областью: по городу (`Калининград`, `Светлогорск`, `Зеленоградск`
и другие муниципалитеты региона), адресам и описаниям с упоминаниями области,
хэштегам (`#калининград`, `#kenig`, `#39регион`) и ссылкам с доменами вида
`...kaliningrad...` или `...klgd...`. Метка не добавляется повторно и не
применяется в ручном режиме (`topics_manual=true`).

## Ручной режим (`topics_manual`)

Флаг `topics_manual` фиксирует ручные темы и защищает их от автоклассификатора.
Пока он установлен:

- `assign_event_topics` возвращает текущее значение и не вызывает модель;
- `/backfill_topics` пропускает событие;
- изменение текста события не приводит к переклассификации.

Переключить режим можно из меню редактирования события: выберите поле
`topics_manual` и отправьте `true`/`false`. В интерфейсе отображается метка
«(ручной режим)», чтобы админы видели источник тем.
