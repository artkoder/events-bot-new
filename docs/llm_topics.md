# Автотемы для событий

Система автоматически классифицирует события по 17 зафиксированным темам. Метки
сохраняются в карточке события и выводятся администраторам в интерфейсе бота.

## Доступные темы

| Идентификатор | Подпись |
|---------------|---------|
| `STANDUP` | «Стендап и комедия» |
| `QUIZ_GAMES` | «Квизы и игры» |
| `OPEN_AIR` | «Фестивали и open-air» |
| `PARTIES` | «Вечеринки» |
| `CONCERTS` | «Концерты» |
| `MOVIES` | «Кино» |
| `EXHIBITIONS` | «Выставки и арт» |
| `THEATRE` | «Театр» |
| `LECTURES` | «Лекции и встречи» |
| `MASTERCLASS` | «Мастер-классы» |
| `SCIENCE_POP` | «Научпоп» |
| `HANDMADE` | «Хендмейд/маркеты/ярмарки/МК» |
| `NETWORKING` | «Нетворкинг и карьера» |
| `ACTIVE` | «Активный отдых и спорт» |
| `PERSONALITIES` | «Личности и встречи» |
| `KIDS_SCHOOL` | «Дети и школа» |
| `FAMILY` | «Семейные события» |

## Системный промпт

Классификатор использует модель 4o (или 4o-mini при включённой переменной
`FOUR_O_MINI`) с системным промптом из кода:

```
Ты — ассистент, который классифицирует культурные события по темам.
Верни JSON с массивом `topics`: выбери от 0 до 3 подходящих идентификаторов тем.
Используй только идентификаторы из списка ниже, записывай их ровно так, как показано, и не добавляй другие значения.
Не отмечай темы про скидки, «Бесплатно» или бесплатное участие и игнорируй «Фестивали», сетевые программы и серии мероприятий.
Не повторяй одинаковые идентификаторы.
Допустимые темы:
- STANDUP — «Стендап и комедия»
- QUIZ_GAMES — «Квизы и игры»
- OPEN_AIR — «Фестивали и open-air»
- PARTIES — «Вечеринки»
- CONCERTS — «Концерты»
- MOVIES — «Кино»
- EXHIBITIONS — «Выставки и арт»
- THEATRE — «Театр»
- LECTURES — «Лекции и встречи»
- MASTERCLASS — «Мастер-классы»
- SCIENCE_POP — «Научпоп»
- HANDMADE — «Хендмейд/маркеты/ярмарки/МК»
- NETWORKING — «Нетворкинг и карьера»
- ACTIVE — «Активный отдых и спорт»
- PERSONALITIES — «Личности и встречи»
- KIDS_SCHOOL — «Дети и школа»
- FAMILY — «Семейные события»
Если ни одна тема не подходит, верни пустой массив.
```

## Формат ответа

От модели ожидается JSON, удовлетворяющий схеме:

```json
{
  "type": "object",
  "properties": {
    "topics": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "STANDUP", "QUIZ_GAMES", "OPEN_AIR", "PARTIES", "CONCERTS",
          "MOVIES", "EXHIBITIONS", "THEATRE", "LECTURES", "MASTERCLASS",
          "SCIENCE_POP", "HANDMADE", "NETWORKING", "ACTIVE",
          "PERSONALITIES", "KIDS_SCHOOL", "FAMILY"
        ]
      },
      "maxItems": 3,
      "uniqueItems": true
    }
  },
  "required": ["topics"],
  "additionalProperties": false
}
```

Выбираются до трёх уникальных идентификаторов. Пустой список означает, что
подходящих тем нет.

## Правила срабатывания

Классификатор вызывается, когда:

- бот сохраняет новые события через `/addevent` или VK-пайплайн; итоговые темы
  наследуются всеми копиями многодневных событий;
- администратор редактирует название, описание или «сырой» текст события
  (поле `source_text`) — переразметка выполняется только если событие не в
  ручном режиме;
- супер-администратор запускает `/backfill_topics` для пересчёта тем у будущих
  событий (по умолчанию в горизонте 90 дней).

В остальных случаях темы остаются без изменений.

## Ручной режим (`topics_manual`)

Флаг `topics_manual` фиксирует ручные темы и защищает их от автоклассификатора.
Пока он установлен:

- `assign_event_topics` возвращает текущее значение и не вызывает модель;
- `/backfill_topics` пропускает событие;
- изменение текста события не приводит к переклассификации.

Переключить режим можно из меню редактирования события: выберите поле
`topics_manual` и отправьте `true`/`false`. В интерфейсе отображается метка
«(ручной режим)», чтобы админы видели источник тем.
