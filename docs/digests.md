# Дайджест лекций

Этот модуль собирает дайджест предстоящих лекций и публикует его одним постом в Telegram.
Превью отправляется в админ‑чат в виде альбома до девяти фотографий с подписью и
инлайн‑клавиатурой для управления.

## Отбор событий

* берём события с `event_type = 'лекция'`;
* базовый горизонт поиска — 7 дней от текущего момента;
* если найдено меньше шести лекций, горизонт расширяется до 14 дней;
* для сегодняшнего дня учитываются только события, которые начнутся минимум через две часа;
* максимум девять лекций в дайджесте;
* сортировка по времени начала по возрастанию, без фильтра по городу.

## Обложки

Обложки берутся только из страниц Telegraph, где встречаются ссылки на
``https://files.catbox.moe/...``. Поддерживаются теги ``<img src>`` и
``<a href>``. Если подходящих ссылок нет, лекция остаётся без фотографии.

## Формат превью и клавиатура

* Альбом до 9 фотографий; подпись добавляется к первому фото (HTML).
* Подпись включает вводную от 4o и список строк вида ``DD.MM HH:MM | <a>Название</a>``.
* Если подпись длиннее 1024 символов, она разбивается на альбом с короткой
  подписью и отдельное сообщение со всем текстом.
* Под альбомом отправляется отдельное сообщение с инлайн‑клавиатурой:
  номера лекций для включения/исключения, кнопка изменения вводной и кнопки
  «Отправить сейчас → <канал>».

## Вводная фраза

Вводная строится автоматически и выглядит как:

> «Подобрали для вас N интересн… лекци… ближайш… недели/двух недель на <топ‑темы>»

где:

* форма «лекци…» зависит от количества: `1 → интересную лекцию`, `2–4 → интересные лекции`, `5+ → интересных лекций`;
* часть «ближайшей недели» используется при горизонте 7 дней, «ближайших двух недель» — при 14;
* список тем собирается из событий, нормализуется по синонимам, считается частота и берутся топ‑3;
* варианты списка тем:
  * одна тема — `на <т1>`
  * две темы — `на <т1> и <т2>`
  * три темы — `на <т1>, <т2> и <т3>`
  * если тем нет — `на разные темы`.

Подпись к альбому ограничена 1024 символами, при превышении лимита список тем сокращается (три → две → одна → «на разные темы»).

# Дайджест психологии

Подборка мероприятий с тематикой психологии собирается тем же пайплайном, что и лекционный дайджест, но с фильтрацией по темам.

## Отбор событий

* берём события, у которых в нормализованных темах присутствует идентификатор `PSYCHOLOGY` (синонимы: `психология`, `psychology`, `mental health`);
* тип события не важен — любые события с подходящей темой попадают в выборку;
* базовый горизонт — 7 дней, расширяем до 14 при нехватке позиций;
* соблюдаем правило «+2 часа» и ограничение в девять карточек;
* сортировка по времени начала, используем `source_post_url/telegraph` как ссылку в списке.

## Вводная фраза

Вводная строится через `compose_psychology_intro_via_4o`. В модель передаём количество событий, горизонт и массив словарей вида:

```json
{
  "title": "Название",
  "description": "Краткое описание",
  "topics": ["PSYCHOLOGY", "self care", "therapy"]
}
```

Темы передаются уже нормализованными, поэтому LLM видит каноническое значение `PSYCHOLOGY` и дополнительные ярлыки от исходного события. Остальные правила оформления превью (альбом, подпись, панель управления) совпадают с лекционным дайджестом.

## Тест-кейс-чеклист

* N = 1, 7, 9 — проверка морфологии.
* Горизонт 7 дней даёт ≥6 лекций → не расширяем; даёт <6 → расширяем на 14.
* Сегодняшние лекции, начинающиеся менее чем через 2 часа, отфильтровываются.
* Длина подписи около 990 символов → один пост; около 1100 → сокращение тем и, если нужно, переход на два сообщения.
* У части лекций нет обложек — альбом короче списка, порядок совпадает.
* Приоритет ссылок: канал анонсов → telegraph → исходник.

## Расширение: автопубликация

Функции `send_digest_preview_to_admin` и `publish_digest_to_channel` позволяют сначала отправить предпросмотр в админ‑чат, а затем опубликовать дайджест в выбранном канале.

# Научпоп

`build_science_pop_digest_candidates` выбирает события, у которых среди нормализованных тем есть `SCIENCE_POP` (синонимы: `научпоп`, `science`, `science_pop`, `технологии`). Тип события значения не имеет — подойдут лекции, встречи, показы и т.д. Пайплайн отбора повторяет лекционный дайджест: базовый горизонт 7 дней, расширение до 14 при недостатке позиций, фильтр «+2 часа» и лимит в девять карточек. Превью строится функцией `build_science_pop_digest_preview`, которая использует общий генератор с существительным «научно-популярных событий».

# Нетворкинг и деловые события

`build_networking_digest_candidates` фильтрует события по нормализованной теме `NETWORKING`. В синонимы входят не только «нетворкинг» и «деловые встречи», но и новые ключевые слова вроде «бизнес-завтрак», «business breakfast», «карьерный вечер». Прочие условия совпадают с базовым пайплайном: горизонт 7→14 дней, правило «+2 часа» и максимум девять карточек. Превью строится через `build_networking_digest_preview`, которое просит 4o подготовить вводную про «N нетворкингов».

# Развлечения (стендап, квизы, вечеринки, open-air)

`build_entertainment_digest_candidates` объединяет события с темами `STANDUP`, `QUIZ_GAMES`, `PARTIES`, `OPEN_AIR`. После нормализации темы складываются, дубликаты убираются, порядок определяется временем начала. Пайплайн тот же: 7 дней, при недостатке позиций расширение до 14, проверка ссылки и лимит девять. Вводная `build_entertainment_digest_preview` использует существующий генератор (`kind="entertainment"`, существительное — «развлечений»).

# Маркеты и хендмейд

`build_markets_digest_candidates` выбирает события с темой `HANDMADE` (ярмарки, маркеты, hand-made). Вводная `build_markets_digest_preview` формулируется с существительным «маркетов». Остальные правила выборки и превью — как в лекционном дайджесте.

# Театр: классика и современность

Для `build_theatre_classic_digest_candidates` и `build_theatre_modern_digest_candidates` добавлено строгое условие `event_type="спектакль"` плюс тема `THEATRE_CLASSIC` или `THEATRE_MODERN`. Это исключает лекции с театральной тематикой. Превью (`build_theatre_classic_digest_preview`/`build_theatre_modern_digest_preview`) прогоняются через общий пайплайн и подставляют вводные «классических спектаклей» и «современных спектаклей» соответственно.

# Встречи и клубы

`build_meetups_digest_candidates` фильтрует события по теме `PERSONALITIES`. Благодаря расширенной таблице синонимов сюда автоматически попадают книжные клубы (`книжный клуб`, `book club`) и другие встречи с героями.

Во время сборки превью (`build_meetups_digest_preview`):

* Заголовки дополнительно нормализуются — если встреча фактически открывает выставку, к названию добавляется пояснение «— творческая встреча и открытие выставки», чтобы редакторы сразу видели контекст. Логика вынесена в `_should_add_meetup_exhibition_clarifier`/`_apply_meetup_postprocessing` в `digests.py`.
* Пэйлоад для LLM обогащён полями `event_type` и списком `formats`, которые строятся детектором `_detect_meetup_formats` (см. `digests.py`). Сейчас поддерживаются теги «клуб», «встреча», «творческий вечер», «нетворкинг», «Q&A», «дискуссия» и «форум».
* Для подсказки тона интро используется счётчик ключевых слов из `_MEETUPS_TONE_KEYWORDS`; при отсутствии попаданий срабатывает шаблон `_DEFAULT_MEETUPS_TONE_HINT` (`простота+любопытство`). Правило ранжирования тонов описано в `_MEETUPS_TONE_PRIORITY`.
* Вводная всегда напоминает про живое общение: знакомства, живое Q&A и нетворкинг. Флаг `has_club` помогает модели усилить акцент, когда клубов нет, но редакторы могут смело ждать «крючок» про людей в любом случае.
* Первая фраза интро обязана начинаться с интригующего приёма на основе фактов событий (например, «Вопрос», «Неожиданный факт»), чтобы моментально зацепить читателя.

Итоговая вводная собирается через `compose_meetups_intro_via_4o`, существительное — «встреч и клубов».

# Кинопоказы

`build_movies_digest_candidates` работает по типу события `кинопоказ` без дополнительных фильтров по темам. `build_movies_digest_preview` формирует вступление про «N кинопоказов». Пайплайн (горизонт, лимиты, проверка ссылок) полностью совпадает с лекционным.
