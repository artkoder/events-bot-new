# Дайджест лекций

Этот модуль собирает дайджест предстоящих лекций и публикует его одним постом в Telegram.
Превью отправляется в админ‑чат в виде альбома до девяти фотографий с подписью и
инлайн‑клавиатурой для управления.

## Отбор событий

* берём события с `event_type = 'лекция'`;
* базовый горизонт поиска — 7 дней от текущего момента;
* если найдено меньше шести лекций, горизонт расширяется до 14 дней;
* для сегодняшнего дня учитываются только события, которые начнутся минимум через две часа;
* максимум девять лекций в дайджесте;
* сортировка по времени начала по возрастанию, без фильтра по городу.

## Обложки

Обложки берутся только из страниц Telegraph, где встречаются ссылки на
``https://files.catbox.moe/...``. Поддерживаются теги ``<img src>`` и
``<a href>``. Если подходящих ссылок нет, лекция остаётся без фотографии.

## Формат превью и клавиатура

* Альбом до 9 фотографий; подпись добавляется к первому фото (HTML).
* Подпись включает вводную от 4o и список строк вида ``DD.MM HH:MM | <a>Название</a>``.
* Если подпись длиннее 1024 символов, она разбивается на альбом с короткой
  подписью и отдельное сообщение со всем текстом.
* Под альбомом отправляется отдельное сообщение с инлайн‑клавиатурой:
  номера лекций для включения/исключения, кнопка изменения вводной и кнопки
  «Отправить сейчас → <канал>».

## Вводная фраза

Вводная строится автоматически и выглядит как:

> «Подобрали для вас N интересн… лекци… ближайш… недели/двух недель на <топ‑темы>»

где:

* форма «лекци…» зависит от количества: `1 → интересную лекцию`, `2–4 → интересные лекции`, `5+ → интересных лекций`;
* часть «ближайшей недели» используется при горизонте 7 дней, «ближайших двух недель» — при 14;
* список тем собирается из событий, нормализуется по синонимам, считается частота и берутся топ‑3;
* варианты списка тем:
  * одна тема — `на <т1>`
  * две темы — `на <т1> и <т2>`
  * три темы — `на <т1>, <т2> и <т3>`
  * если тем нет — `на разные темы`.

Подпись к альбому ограничена 1024 символами, при превышении лимита список тем сокращается (три → две → одна → «на разные темы»).

# Дайджест психологии

Подборка мероприятий с тематикой психологии собирается тем же пайплайном, что и лекционный дайджест, но с фильтрацией по темам.

## Отбор событий

* берём события, у которых в нормализованных темах присутствует идентификатор `PSYCHOLOGY` (синонимы: `психология`, `psychology`, `mental health`);
* тип события не важен — любые события с подходящей темой попадают в выборку;
* базовый горизонт — 7 дней, расширяем до 14 при нехватке позиций;
* соблюдаем правило «+2 часа» и ограничение в девять карточек;
* сортировка по времени начала, используем `source_post_url/telegraph` как ссылку в списке.

## Вводная фраза

Вводная строится через `compose_psychology_intro_via_4o`. В модель передаём количество событий, горизонт и массив словарей вида:

```json
{
  "title": "Название",
  "description": "Краткое описание",
  "topics": ["PSYCHOLOGY", "self care", "therapy"]
}
```

Темы передаются уже нормализованными, поэтому LLM видит каноническое значение `PSYCHOLOGY` и дополнительные ярлыки от исходного события. Остальные правила оформления превью (альбом, подпись, панель управления) совпадают с лекционным дайджестом.

## Тест-кейс-чеклист

* N = 1, 7, 9 — проверка морфологии.
* Горизонт 7 дней даёт ≥6 лекций → не расширяем; даёт <6 → расширяем на 14.
* Сегодняшние лекции, начинающиеся менее чем через 2 часа, отфильтровываются.
* Длина подписи около 990 символов → один пост; около 1100 → сокращение тем и, если нужно, переход на два сообщения.
* У части лекций нет обложек — альбом короче списка, порядок совпадает.
* Приоритет ссылок: канал анонсов → telegraph → исходник.

## Расширение: автопубликация

Функции `send_digest_preview_to_admin` и `publish_digest_to_channel` позволяют сначала отправить предпросмотр в админ‑чат, а затем опубликовать дайджест в выбранном канале.
