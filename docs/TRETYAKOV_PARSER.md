# Парсер Третьяковской галереи (Калининград)

## Обзор

Парсер для событий Третьяковской галереи Калининград: [kaliningrad.tretyakovgallery.ru/events/](https://kaliningrad.tretyakovgallery.ru/events/)

---

## Пользовательские требования

### 1. Алгоритм парсинга (как делает пользователь на сайте)

![Схема парсинга](assets/tretyakov_parsing_flow.png)

**Последовательность шагов:**

1. **Страница списка** `/events/` → выбор карточки события
2. **Детальная страница** события → получение описания и кнопки "КУПИТЬ БИЛЕТ"
3. **Страница билетов** (через кнопку) → попадаем в виджет с календарём
4. **Календарь** → кликаем стрелки (→) для прокрутки
5. **Активные даты** (яркие, не приглушённые) → кликаем каждую
6. **Времена** → для каждой даты получаем доступные времена
7. **Сектор** (если есть) → кликаем чтобы увидеть цену
8. **Цена** → извлекаем минимальную

---

### 2. Ключевые правила

#### 2.1. Отдельная запись на каждую дату+время

> **ВАЖНО:** Каждая комбинация дата+время — это отдельное событие в системе, потому что у каждого может быть независимый статус доступности билетов.

**Пример:** "Сказка про Люта" проходит 5-10 января в 13:00 и 15:00 каждый день  
**Результат:** 12 отдельных записей (6 дней × 2 времени)

#### 2.2. Кликать только ЯРКИЕ даты

В календаре есть:
- **Яркие даты (active)** — доступны для покупки → кликаем
- **Приглушённые даты** — недоступны → игнорируем

CSS селектор: `div.item.active`

#### 2.3. Direct URL для Pianissimo

Для событий типа "PIANISSIMO: Исполнитель" на детальной странице есть кнопка "КУПИТЬ БИЛЕТ" с **прямой ссылкой**, содержащей дату:

```
/tickets/#/buy/event/42168/2026-01-30/20:00:00
                           ^^^^^^^^^^^^^^^^^^
                           Дата и время в URL
```

**Используем эту дату!** Не ищем все даты в общем календаре фестиваля.

---

### 3. Дедупликация фестивальных событий

![Схема дедупликации](assets/tretyakov_dedup_logic.png)

#### Проблема

Третьяковка заводит **И** общий фестиваль (например "ЗИМНИЙ ФЕСТИВАЛЬ PIANISSIMO"), **И** отдельные события исполнителей (например "PIANISSIMO: СЫНИАН КИМ"). 

При парсинге получаются дубликаты:
- "ЗИМНИЙ ФЕСТИВАЛЬ PIANISSIMO" на 8 января 14:00
- "PIANISSIMO: СЫНИАН КИМ" на 8 января 14:00

...это одно и то же событие!

#### Решение

**Правило дедупликации:**

При совпадении `(дата, время, зал)` оставляем **ТОЛЬКО** событие с источником `direct_url_date`, удаляем событие с источником `all_dates_extracted`.

| Поле | Фестиваль | Исполнитель |
|------|-----------|-------------|
| Дата | 8 января 14:00 | 8 января 14:00 |
| Зал | Атриум | Атриум |
| Источник | `all_dates_extracted` | `direct_url_date` |
| **Оставляем?** | ❌ Нет | ✅ Да |

**Объединение фото:** При дедупликации фото из удаляемого события (фестиваля) добавляются к оставленному событию (исполнителя) как 2-е, 3-е фото.

**Логика:** Событие с `direct_url_date` — это конкретный исполнитель, указанный именно на эту дату. Событие с `all_dates_extracted` — это общая страница фестиваля, которая захватила много дат.

---

### 4. Полные описания

> **ВАЖНО:** Собирать **ВСЕ** параграфы с детальной страницы, не только первый.

Описания событий могут быть длинными (до 20000+ символов). Пропускаем только:
- Короткие тексты (< 30 символов)
- Технические тексты (cookie, политика, режим работы)

---

### 5. Извлечение цен

**Для Кинозала:** Цена видна сразу после выбора даты+времени

**Для Атриума:** Нужно кликнуть на **каждый сектор** и собрать ВСЕ цены:
- "Сектор 1 (лестница атриума)" → 1500 ₽
- "Сектор 2 (стулья партера)" → 2000 ₽

> **ВАЖНО:** Сохраняем **ticket_price_min** и **ticket_price_max** — минимальную и максимальную цену по всем секторам. Бот показывает диапазон цен пользователю.

После клика на сектор цена появляется в элементе `.ticket-price`.

---

## Технические детали

### Файлы парсера

| Файл | Назначение |
|------|------------|
| `scripts/update_tretyakov_nb.py` | Основной код для Kaggle |
| `debug_tretyakov_v2.py` | Локальный тест-скрипт |
| `kaggle/ParseTheatres/parse_theatres.ipynb` | Ноутбук Kaggle |

### Поля источника (`source`)

| Значение | Описание |
|----------|----------|
| `direct_url_date` | Дата из URL кнопки "Купить билет" (Pianissimo) |
| `all_dates_extracted` | Все даты из календаря виджета |
| `detail_page_fallback` | Дата с детальной страницы (запасной вариант) |
| `no_dates` | Дат не найдено |

---

## История изменений

- **2026-01-02**: Добавлены требования пользователя по дедупликации и полным описаниям
- **2025-XX-XX**: Первоначальная реализация
