# План реализации парсера Третьяковской галереи (Калининград)

## 1. Обзор
Необходимо добавить поддержку парсинга событий с сайта [kaliningrad.tretyakovgallery.ru](https://kaliningrad.tretyakovgallery.ru/events/) в существующий ноутбук `parse_theatres.ipynb`.
Парсер должен использовать **Playwright**, собирать названия, даты, изображения, локации и цены билетов (через виджет покупки).

## 2. Структура сайта

### 2.1. Страница списка событий (`/events/`)
- **Контейнер события**: `.card`
- **Заголовок**: Внутри `.card` -> `.card_info` -> `.card_info-top` -> `.card_title` (текст)
- **Ссылка на билет/детали**: Внутри `.card_info-top` -> `a` (атрибут `href`)
- **Изображение**: Внутри `.card` -> `img.card_img` (атрибут `src`) или `div.card_img` (style `background-image`)
- **Дата и время**: Внутри `.card_info` (текстовое содержимое, исключая заголовок и кнопку). Обычно нижняя часть карточки.
- **Локация**: "Атриум" или "Кинозал" (определять по наличию текста в карточке).

### 2.2. Страница билета (Widget SPA)
Ссылка на билет имеет формат `/tickets/#/buy/event/{ID}`. Страница является SPA (Single Page Application).
**Алгоритм получения цены:**
1. Переход по ссылке.
2. Ожидание загрузки контейнера виджета (селекторы `.skin-inner`, `.wrapper`, или текст "Выберите дату").
3. **Выбор даты (если есть)**:
   - Проверить наличие календаря или списка дат (например, элементы с днями недели/числами).
   - Если есть кнопки дат/времени, кликнуть на первую активную.
   - Подождать обновления контента.
4. **Выбор сектора (если есть)**:
   - Проверить наличие кнопок/элементов с текстом "Сектор", "Входной", "Места".
   - Если цены не видны сразу, кликнуть на сектор.
5. **Извлечение цены**:
   - Искать текст соответствующий паттерну `\d+\s*₽` (например "500 ₽").
   - Собрать все уникальные цены, сформировать диапазон (min - max).
6. **Статус**:
   - Если цены найдены -> `available`.
   - Если текст "Нет билетов" или "Sold out" -> `sold_out`.

## 3. Требуемые изменения

### 3.1. Файл `kaggle/ParseTheatres/parse_theatres.ipynb`
Добавить новую секцию **ЧАСТЬ 3: ТРЕТЬЯКОВСКАЯ ГАЛЕРЕЯ** с функциями:
- `scrape_tretyakov_schedule(page)`: Сбор списка событий.
- `scrape_tretyakov_ticket_price(context, url)`: Переход в виджет и парсинг цен.
- `run_tretyakov(browser)`: Оркестрация.

**Важно**:
- Использовать `try/except` блоки для надежности.
- Добавить задержки (`page.wait_for_timeout`) для имитации пользователя.
- Логировать процесс (print).

### 3.2. Файл `docs/reference/locations.md`
Убедиться, что локация добавлена (уже есть: `Филиал Третьяковской галереи, Парадная наб. 3, #Калининград`).

### 3.3. Файл `source_parsing/parser.py`
- Обновить `parse_theatre_json` для обработки нового `source_type="tretyakov"`.
- Убедиться, что `normalize_location_name` корректно обрабатывает "Атриум" и "Кинозал" как части локации Третьяковки (или приводить всё к главной локации).

## 4. Инструкция для Codex
1. **Не менять** логику существующих парсеров (Драмтеатр, Музтеатр, Собор).
2. Реализовать парсинг Третьяковки максимально надежно (SPA ожидание).
3. Сохранять результат в `tretyakov.json` и `tretyakov.csv`.
4. В `main` функции ноутбука добавить вызов `run_tretyakov` и объединение результатов.
