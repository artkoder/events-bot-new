# Автоматический Скоринг Событий (Event Scoring)

## 1. Цель
Выявлять события, наиболее интересные для аудитории (High Interest Events), чтобы приоритизировать их показ и визуально выделять. Основная метрика интереса — реакция пользователей на исходный пост в канале-источнике (просмотры, лайки).

## 2. Механика Скоринга

### 2.1. Сбор Данных
При парсинге Telegram-канала (см. `features/telegram-monitoring`) собираются метрики для каждого поста:
- `views`: Количество просмотров.
- `likes`: Количество лайков/реакций.

### 2.2. Расчет Бейзлайна (Baseline)
Для каждого канала робот рассчитывает "норму" интереса на основе исторических данных (скользящее окно или периодический пересчет):
- `channel_median_views`: Медиана просмотров последних N постов.
- `channel_median_likes`: Медиана лайков.

## 2. Единый Скоринговый Балл (Unified Score)

Итоговый балл события (1-10) является **единым** и формируется из двух компонентов: семантической оценки (Base) и метрик популярности (Boost).

### 2.1. Базовый Балл (Base Score) - LLM
Определяется моделью Gemma на основе описания события (контента).
- **Источник:** Промпт при разборе события или Daily Job.
- **Диапазон:** 1-10.
- **Критерии:** Уникальность, качество описания, масштаб, известность площадки/артиста.

### 2.2. Бонус Популярности (Popularity Boost) - Telegram Metrics
Если событие пришло из Telegram и имеет статистику просмотров/лайков:
1.  Сравниваем метрики поста с медианой канала.
2.  Если `views > 1.5 * median` или `likes > 1.5 * median`:
    - **Boost:** +1..+3 балла к Base Score.
3.  *Примечание:* Популярность может только **повысить** балл. Низкие просмотры не должны занижать оценку качественного контента (т.к. канал может быть маленьким).

### 2.3. Итоговая Формула
`Final Score = min(10, Base Score + Boost)`

*Пример:*
*   LLM оценила концерт как "7/10".
*   Пост собрал в 2 раза больше просмотров, чем обычно в этом канале -> Boost +2.
*   Итог: 9/10 (Хит).

## 3. Процесс Оценки

### 3.1. При создании (Ingestion)
1.  **LLM:** При первичном разборе Gemma ставит Base Score.
2.  **Metrics:** Если источник Telegram, сразу проверяем метрики и добавляем Boost.
3.  **Сохранение:** Записываем итоговый балл в БД.

### 3.2. Daily Job (Переоценка)
Регулярная задача может обновлять балл, если:
- Появились новые данные по просмотрам (пост "вирусится").
- Событие было добавлено без оценки (старые записи).

## 4. Использование Результатов

### 4.1. Отдельные Посты (Featured Posts)
События с **Score >= 8** (порог настраивается) попадают в отдельную очередь контент-плана:
- Для них делается **полный рерайт** текста с акцентом на популярность.
- Публикуются **отдельным постом** в канале бота, а не только ссылкой на Telegraph.

### 3.2. Визуальное Выделение (3D Previews)
При генерации 3D-афиши (команда `/3di` и `features/crumple-video`):
- Если у события высокий Score, на видео/гифку добавляется визуальный маркер (звездочка ✨, плашка "HOT", или особое свечение).
- Это позволяет пользователю при беглом просмотре ленты сразу зацепиться глазом за популярное событие.

### 3.3. Отчетность
В отчете мониторинга (`/parse`) блок "High Score Events" показывает, какие именно метрики "выстрелили" у события.
