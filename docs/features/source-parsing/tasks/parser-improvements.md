# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ø–∞—Ä—Å–µ—Ä—É

## ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –ì–¥–µ |
|--------------|-----|
| RDR –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Render-Distill-Reason) | `render.py`, `distill.py`, `reason.py` |
| Function Calling —Å JSON-—Å—Ö–µ–º–æ–π | `reason.py` SYSTEM_PROMPT |
| Rate limiting (RPM 30, TPM 15K) | `rate_limit.py` —Å 45%/85% –∑–∞–ø–∞—Å–æ–º |
| –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ | `regional_filter.py` |
| LLM Logger | `llm_logger.py` |
| Venues —Å geo –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ | UDS schema |
| `participants[]`, `works[]` | UDS schema + –ø—Ä–æ–º–ø—Ç |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç "today's date" –¥–ª—è year inference | `distill.py` `prepare_llm_context()` |
| `images_festival[]` | UDS schema |

---

## üéØ –ü–æ–ª–µ–∑–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### 1. API Interception (HIGH)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∞–π—Ç—ã (pyramida.info) –≥—Ä—É–∑—è—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ XHR/JSON.

**–†–µ—à–µ–Ω–∏–µ:** Playwright –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON –Ω–∞–ø—Ä—è–º—É—é.

```python
# –í render.py
page.on("response", lambda r: save_json_if_schedule(r))
```

**–ö–æ–≥–¥–∞:** –ü—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ render.py

---

### 2. LLM Request Chunking (MEDIUM)
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—á–µ–Ω—å –±–æ–ª—å—à–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–±–∏–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º.

**–£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ:** `distill.py` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –Ω–∞–≤–±–∞—Ä/—Ñ—É—Ç–µ—Ä

---

### 3. Retry —Å Exponential Backoff (MEDIUM)
**–¢–µ–∫—É—â–µ–µ:** –ï—Å—Ç—å retry –≤ rate_limit.py

**–£–ª—É—á—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å backoff –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö

```python
for attempt in range(3):
    await asyncio.sleep(2 ** attempt)
```

---

### 4. Screenshot + LLM –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö UI (LOW)
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∞–π—Ç—ã —Å–æ –≤–∫–ª–∞–¥–∫–∞–º–∏/–∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ —Ç—Ä–µ–±—É—é—Ç –∫–ª–∏–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä–∏–Ω—à–æ—Ç ‚Üí LLM –∞–Ω–∞–ª–∏–∑ ‚Üí Playwright –∫–ª–∏–∫

**–ö–æ–≥–¥–∞:** –ü—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏ —Å —Ç–∞–∫–∏–º–∏ —Å–∞–π—Ç–∞–º–∏

---

## ‚ùå –ù–µ –Ω—É–∂–Ω–æ

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –ü—Ä–∏—á–∏–Ω–∞ |
|--------------|---------|
| –û—Ç–¥–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å "Ticket" | –£—Å–ª–æ–∂–Ω—è–µ—Ç —Å—Ö–µ–º—É; `price_min/max` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ JSON | –£–∂–µ –µ—Å—Ç—å `parser_run_id`, `last_parsed_at` |
| –§–ª–∞–≥ `complete` | –õ–æ–≥–∏–∫–∞ —É–∂–µ –≤ `process_festival_url()` |
| –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–¥–∞–Ω–∏–π –≤ –≥–æ–¥ | –†–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é |
