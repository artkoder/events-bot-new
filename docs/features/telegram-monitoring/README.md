# Интеллектуальный мониторинг ТГ-каналов (Kaggle + Telethon + Gemma)

## 1. Архитектура и Структура

Логика реализуется в пакете `source_parsing/telegram` и новом Kaggle-ноутбуке.
**Основной принцип:** Kaggle — это интеллектуальный фильтр. Он не просто парсит, он принимает решение о новизне события, сверяясь с "картиной мира" (Telegraph-страницами).

## 2. Безопасность и Сессия (Samsung S22 Ultra)

### Генератор сессии
Скрипт `scripts/generate_tg_session.py` предназначен для локального запуска.

### Параметры устройства
Строго зашиты для маскировки под реальное устройство:
- `app_version`
- `system_version`
- `device_model="Samsung S22 Ultra"`

### Передача
Session String передается в Kaggle через механизм **secrets** (разбиение на чанки/датасеты, сборка в памяти), чтобы избежать утечки в публичные логи.

## 3. Логика работы Kaggle Ноутбука (The Brain)

Ноутбук выполняет полный цикл анализа.
**Входные параметры:** `TG_SESSION`, список каналов, ссылки на текущие страницы-афиши месяца в Telegraph (для дедупликации).

### Шаг 1: Сбор и первичная фильтрация (Telethon)
- Имитация поведения человека (human-like requests, случайные задержки).
- Сбор постов за последние **N часов**.
- Фильтрация мусора (реклама, репосты без текста) по ключевым словам.

### Шаг 2: Выявление события (Gemma Analysis)
Каждый потенциальный пост отправляется в Gemma.

**Промпт:**
> "Проанализируй текст. Является ли это анонсом события? Если да, извлеки: Название, Дата, Время, Место, Краткое описание. Если нет — верни null".

**Результат:** Структурированный объект события или пропуск.

### Шаг 3: Умная Дедупликация (Gemma + Telegraph Context)
> **Важное изменение:** Дедупликация происходит здесь, до загрузки картинок.

1.  **Загрузка контекста:** Ноутбук парсит текст с актуальных страниц Telegraph (например, "Афиша Январь", "Афиша Февраль"), ссылки на которые переданы при запуске.
2.  **Сравнение:** Gemma получает на вход:
    - Список событий с Telegraph (Название, Дата, Место).
    - Новое найденное событие.
3.  **Промпт:**
    > "Сравни новое событие с существующими. Проверь совпадение по смыслу (нечеткое сравнение названий), дате и локации. Если это событие уже есть в списке — пометь как ДУБЛЬ".
4.  **Действие:** Если дубль — пост отбрасывается (логгируется как `SKIP`).

### Шаг 4: Обработка медиа (Catbox)
Выполняется **только если событие прошло проверку на уникальность**.

Если в посте есть изображение (афиша):
1.  Скачать файл в память (или временную директорию Kaggle).
2.  Загрузить на `Catbox.moe`.
3.  Получить URL.
4.  Удалить локальный файл.

### Шаг 5: Формирование результата
Ноутбук сохраняет `telegram_results.json`:

```json
[
  {
    "status": "new",
    "source_link": "https://t.me/channel/123",
    "original_text": "...",
    "catbox_url": "https://files.catbox.moe/xyz.jpg",
    "extracted_data": {
      "title": "Концерт Баха",
      "date": "2025-11-20",
      "time": "19:00",
      "location": "Кафедральный собор"
    }
  }
]
```

## 4. Серверная часть (Controller & Writer)

### 4.1. Подготовка запуска (Job Payload)
При запуске Kaggle-ноутбука сервер должен передать ему не только секреты, но и контекст для дедупликации:
1.  Получить из БД актуальные ссылки на Telegraph-страницы месяцев (текущий + следующий).
2.  Передать эти ссылки в конфигурацию ноутбука.

### 4.2. Обработка результата (Gemma Rewrite & Save)
После завершения работы ноутбука сервер забирает JSON.

#### Рерайт (Gemma Only)
Для каждого события из JSON запускается Gemma.
- **Задача:** Переписать `original_text` (или использовать `extracted_data` как фактуру) в стиле "журналиста-событийщика".
- **Запрет:** Использование других LLM (OpenAI и т.д.) запрещено для этой задачи. Только Gemma (через существующий единый фреймворк лимитов).

#### Сохранение
1.  Добавление события в базу данных через стандартный механизм использующий LLM для разбора события (`event_utils.add_event...`).
2.  Использование полученного `catbox_url` для обложки.
3.  Обновление Telegraph-страниц (через существующий механизм ребилда).

#### Отчетность
В админский чат отправляется отчет:
> "Найдено событий: X. Из них новых: Y (добавлены). Дубликатов отсеяно в ноутбуке: Z."

Список добавленных событий выдается в виде списка со ссылками на телеграф страницы каждого события.

## 5. Детали реализации и Лимиты

- **Rate Limiter:** Использовать существующий класс `RateLimiter` с настройкой "50% от лимитов Google" внутри ноутбука для запросов к Gemma.
- **Сервисная архитектура:**
    - `source_parsing/telegram/service.py` — оркестратор.
    - `source_parsing/telegram/deduplication.py` — логика подготовки данных для проверки дублей (на сервере).
- **Модульность:** В самом ноутбуке код должен быть модульным (можно использовать загрузку .py файлов из датасета или src папки, как сделано в `UniversalFestivalParser`).
