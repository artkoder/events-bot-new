# Интеллектуальное Обновление События (Smart Event Update)

> **Статус:** Planned / In Design
> **Цель:** Создать единую точку входа для накопления и обогащения информации о событиях из разрозненных источников, исключая дублирование и потерю данных.

## 1. Философия
Каждое событие в базе данных — это *"живой"* объект, который может дополняться информацией из разных источников (Vk, Telegram, Сайты).
Система не должна просто "перезаписывать" данные последним пришедшим источником. Она должна **накапливать** знания, разрешая конфликты на основе авторитетности источника.

## 2. Принципы Работы

### 2.1. Каноничность Источников (Canonical Priority)
У каждого источника есть "вес" достоверности для разных типов данных.

| Тип Источника | Приоритет (Вес) | Доверие (Trust Level) | Пример |
| :--- | :--- | :--- | :--- |
| **Official Site / Ticket System** | **High (Canonical)** | 100% | `dramteatr39.ru`, `klops.ru/afisha`, `pyramida.info` |
| **Official Public Page** | **Medium** | 80% | Официальная группа театра в VK/TG |
| **Aggregator / Social Post** | **Low** | 50% | Пост в городском паблике "Куда сходить" |

**Правила слияния:**
1.  **Core Data (Дата, Время, Место, Цена):**
    *   Если поле заполнено из **High** источника, **Low** источник НЕ может его изменить (только предложить как "альтернативу" для ручной проверки, если различие критическое).
    *   Если поле пустое -> любой источник может его заполнить.
2.  **Enrichment (Описание, Детали):**
    *   Тексты дополняются. Если в оф. источнике сухо ("Концерт Баха"), а в паблике богатое описание ("Живой звук, свечи..."), описание из паблика **добавляется** (merge) к существующему, а не заменяет его.
3.  **Conflict Resolution:**
    *   Если `Official Site` говорит "19:00", а `Social Post` говорит "20:00" -> Побеждает **Official Site**.
    *   Если `Social Post` (New) противоречит `Social Post` (Old) -> Побеждает **New** (свежая инфа).

### 2.2. Работа с Изображениями (Smart Image Management)
Событие может обрастать картинками из разных постов.
1.  **Deduplication:** При добавлении новой картинки проверяется её перцептивный хеш (pHash) с уже имеющимися. Полные дубли игнорируются.
2.  **Poster Priority (Приоритет Афиш):**
    *   Система (через Vision AI) определяет тип картинки: `Poster` (с текстом) или `Mood/Photo` (просто фото).
    *   **Правило:** В качестве обложки всегда выбирается `Poster` с наибольшим разрешением и читаемым текстом.
    *   `Mood` картинки сохраняются в галерею, но не заменяют Афишу на обложке.

## 3. Роль AI (Gemma 3-27b)
Модель используется как арбитр при слиянии:
- **Input:** JSON текущего состояния события + JSON нового источника.
- **Task:** "Объедини данные. Если есть противоречие в дате/месте, верь Источнику А. Если описание в Б лучше — дополни им А."
- **Output:** Обновленный JSON события.

### 3.1. Смысловые Единицы (Key Facts)
Для оценки полезности обновления вводится понятие **"Смысловой Единицы" (Key Fact)**.
Это атомарный факт, имеющий ценность для посетителя, например:
*   "Дресс-код black tie"
*   "Разогрев группы X"
*   "Наличие парковки"
*   "Специальный гость"

**Процесс:**
1.  Gemma извлекает список фактов из нового источника.
2.  Сравнивает с уже известными фактами о событии.
3.  **Отчет о мерже:** "Событие обновлено. Добавлено **2 новых факта**: [Дресс-код, Имя специального гостя]."

### 3.2. Генерация Описания (AI Rewrite)
После каждого успешного обогащения (добавления новых Key Facts):
1.  Берется полный набор накопленных фактов.
2.  Gemma генерирует **новое связное описание** для Telegraph-страницы.
3.  *Результат:* Текст всегда выглядит целостным и актуальным, а не как "лоскутное одеяло" из разных постов.

## 4. Этапы Внедрения
1.  **Phase 1 (Design):** Документирование правил (Current).
2.  **Phase 2 (Prototype):** Реализация модуля `SmartUpdateService`.
3.  **Phase 3 (Migration):** Подключение VK и Telegram парсеров к этому сервису как к единственной точке входа.
