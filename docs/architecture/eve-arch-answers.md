# Ответы владельца продукта на вопросы архитектуры EVE

Дата: 2026-01-07

## A) Kaggle и секреты (EVE-54)

**1. Kaggle вызывает Google AI напрямую или через gateway?**
→ **Напрямую**. Бот запускает Kaggle notebook с интернетом, notebook делает запросы в Google API.

**2. Доступ Kaggle к Supabase?**
→ **Да, нужно пробрасывать** Supabase credentials в Kaggle notebook.

**3. Хранить ключи в Supabase?**
→ **Нельзя**. Ключи только в env/secrets.

**4. Аутентификация gateway?**
→ Не применимо (нет gateway).

## B) Семантика лимитов (EVE-11)

**5-6. Лимиты и account_name:**
→ Лимиты **на ключ**, ключ привязан к аккаунту.
→ `account_name` на проде через секреты, локально через ENV.

**7. TZ для RPD:**
→ UTC (по умолчанию).

## C) Модели (EVE-55)

**8. Каноническое имя модели:**
→ `gemma-3-27b`

**9. Gemma и Gemini:**
→ Gemma основная, Gemini тоже есть (для инструкций).

## D) Токены

**10. Кто считает planned_tokens:**
→ **Не нужно** — Google API всегда возвращает usage в ответе.

**11. Fallback если нет usage:**
→ Не актуально — usage всегда есть в ответе API.

## E) Схема Supabase

**12. SQL-миграции:**
→ Можно создать, но **обратная совместимость** с `token_usage` обязательна.

**13-14. Схема rpd_used и доп. таблицы:**
→ Можно модифицировать/добавлять с учётом обратной совместимости.

## F) Ретраи и блокировки

**15. Ретраи:**
→ Только на **провайдерные ошибки**. При лимитах — сразу ошибка.

**16. WAIT режим:**
→ **Не нужен**. При блокировке — сразу ошибка.

**17. Дневной блок:**
→ **Ошибка сразу** (не ждать 24 часа).

---

## Резюме решений

| Аспект | Решение |
|--------|---------|
| Архитектура | SDK (не gateway) |
| Kaggle | Прямые вызовы + Supabase для координации |
| Ключи | Только в env/secrets, не в БД |
| Лимиты | На ключ, проверка через Supabase |
| При блокировке | Сразу ошибка (не WAIT) |
| Ретраи | Только на провайдерные ошибки (макс 3) |
| Usage токенов | Из ответа Google API |
| Миграции | С обратной совместимостью |
