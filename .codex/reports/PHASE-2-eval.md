# Phase 2 — Completeness vs docs/

## Документы и требования
- В `docs/` нет явного описания механизма deferred rebuilds, параметра `next_run_at`, dirty-флага или напоминаний. Единственное релевантное требование — US-06: «maintain month/week/weekend pages» (`docs/USER_STORIES.md`).
- По US-06 текущая реализация сохраняет обновление навигационных страниц, но делает его отложенным (15 минут). Это не противоречит документам, т.к. сроки обновления не регламентированы.

## Missing pieces / неполнота
- **Dirty-flag не используется**: `mark_pages_dirty`/`load_pages_dirty_state` не имеют потребителя (нет фоновой проверки/напоминаний/авто-ребилда). Состояние хранится, но ничего не делает.
- **Дебаунс не гарантирован**: при повторном `enqueue_job` для коалесцированной задачи `next_run_at` сбрасывается на `now`, т.е. отложенный запуск может стать немедленным.
- **Навигационный drain конфликтует с defer**: `_drain_nav_tasks` будет ждать deferred задачи до таймаута, что замедлит часть потоков, хотя смысл отложенности — наоборот разгрузка.

## Поведение при отмене/перезапуске
- **Перезапуск воркера**: отложенные задачи живут в `JobOutbox` и будут выполнены после рестарта, когда `next_run_at` наступит. Это OK.
- **Отмена/пауза**: явного механизма отмены deferred-задач нет. Если задача помечена `paused`/`error`, она не возобновится автоматически без нового `enqueue_job`.
- **Повторное планирование**: повторный вызов `schedule_event_update_tasks` для того же месяца фактически «перезапускает» задачу (ставит `next_run_at=now`), что отменяет отложенный режим вместо продления/сохранения окна ожидания.

