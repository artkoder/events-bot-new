# Фаза 4 — Итоговый отчёт

## Причина проблемы (предположительно)
- `log_token_usage()` использовал `asyncio.create_task()` и возвращал управление сразу, поэтому запись в Supabase могла не выполниться при завершении/перезапуске процесса или остановке event loop.
- Подтвердить через прод-логи не удалось из-за отсутствия `flyctl` и сетевых ограничений.

## Решение
- Сделал запись в Supabase синхронной относительно вызова `log_token_usage()` (всё ещё в отдельном потоке, но теперь с `await`).

## Что изменилось
- `main.py`: `log_token_usage()` теперь `await`-ит `_log()` вместо `asyncio.create_task()`.
- `main.py`: debug-сообщение обновлено (`scheduling` → `start`).
