============================= test session starts ==============================
platform linux -- Python 3.12.1, pytest-9.0.1, pluggy-1.6.0
rootdir: /workspaces/events-bot-new
configfile: pytest.ini
plugins: anyio-4.12.0, asyncio-0.23.6
asyncio: mode=Mode.STRICT
collected 1 item

tests/test_immediate_rebuild_skip.py F                                   [100%]

=================================== FAILURES ===================================
________________ test_skip_immediate_rebuild_if_deferred_exists ________________

tmp_path = PosixPath('/tmp/pytest-of-codespace/pytest-15/test_skip_immediate_rebuild_if0')

    @pytest.mark.asyncio
    async def test_skip_immediate_rebuild_if_deferred_exists(tmp_path):
        """
        Verify that update_telegraph_event_page skips calling update_month_pages_for
        if a deferred month_pages job exists for the same month.
        """
        db = Database(str(tmp_path / "db.sqlite"))
        await db.init()
    
        # Setup: Create an event
        async with db.get_session() as session:
            ev = Event(
                title="Test Event",
                description="Test Description",
                date="2026-05-15",
                time="10:00",
                location_name="Location",
                source_text="src",
                telegraph_url="https://telegra.ph/existing",
                content_hash="old_hash"
            )
            session.add(ev)
            await session.commit()
            await session.refresh(ev)
            event_id = ev.id
    
        # Mock dependencies
        # We need to mock build_source_page_content, telegraph, etc. to avoid external calls
        # but strictly speaking we only care about update_month_pages_for call.
    
        with patch("main.build_source_page_content") as mock_build, \
             patch("main.Telegraph", new_callable=MagicMock) as mock_tg_cls, \
             patch("main.update_month_pages_for", new_callable=AsyncMock) as mock_update_month, \
             patch("main.get_telegraph_token", return_value="fake_token"), \
             patch("main.content_hash", return_value="new_hash_diff"), \
             patch("main.telegraph_create_page", new_callable=AsyncMock) as mock_create:
    
            mock_build.return_value = ("<p>Hello</p>", [], [])
            mock_create.return_value = {"url": "https://t.ph/new", "path": "new_path"}
    
            # Case 1: No deferred job -> Should call update_month_pages_for
            await update_telegraph_event_page(event_id, db, None)
            mock_update_month.assert_called_once()
            mock_update_month.reset_mock()
    
            # Case 2: Deferred job exists -> Should SKIP update_month_pages_for
            async with db.get_session() as session:
                # Add deferred job
                future = datetime.now(timezone.utc) + timedelta(minutes=15)
                job = JobOutbox(
                    event_id=event_id, # Can be any ID or None usually, but month_pages key matters
                    task=JobTask.month_pages,
                    status=JobStatus.pending,
                    coalesce_key="month_pages:2026-05",
                    next_run_at=future,
                    updated_at=datetime.now(timezone.utc)
                )
                session.add(job)
                await session.commit()
    
            # Run again
            await update_telegraph_event_page(event_id, db, None)
            mock_update_month.assert_not_called()
    
            # Case 3: Deferred job exists but executed/failed (not pending) -> Should call
            async with db.get_session() as session:
                jobs = (await session.execute(select(JobOutbox))).scalars().all()
                for j in jobs:
                    j.status = JobStatus.done
                    session.add(j)
                await session.commit()
    
            mock_update_month.reset_mock()
            await update_telegraph_event_page(event_id, db, None)
>           mock_update_month.assert_called_once()

tests/test_immediate_rebuild_skip.py:89: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock name='update_month_pages_for' id='138397326431328'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'update_month_pages_for' to have been called once. Called 0 times.

/usr/local/python/3.12.1/lib/python3.12/unittest/mock.py:923: AssertionError
----------------------------- Captured stderr call -----------------------------
INFO:root:TG-EVENT [E1] done | url=https://t.ph/new
------------------------------ Captured log call -------------------------------
INFO     root:main.py:60 TG-EVENT [E1] done | url=https://t.ph/new
=========================== short test summary info ============================
FAILED tests/test_immediate_rebuild_skip.py::test_skip_immediate_rebuild_if_deferred_exists
============================== 1 failed in 0.25s ===============================
Exception ignored in: <module 'threading' from '/usr/local/python/3.12.1/lib/python3.12/threading.py'>
Traceback (most recent call last):
  File "/usr/local/python/3.12.1/lib/python3.12/threading.py", line 1623, in _shutdown
    lock.acquire()
KeyboardInterrupt: 
